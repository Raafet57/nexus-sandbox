name: CI - Test & Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  backend-tests:
    name: Backend Tests (Python)
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: nexus_test
          POSTGRES_USER: nexus
          POSTGRES_PASSWORD: nexus_test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Set up Python ğŸ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'services/nexus-gateway/requirements*.txt'

      - name: Install Dependencies ğŸ“¦
        working-directory: services/nexus-gateway
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run Linting ğŸ§¹
        working-directory: services/nexus-gateway
        run: |
          flake8 src --count --select=E9,F63,F7,F82 --show-source --statistics
          black --check src || true

      - name: Run Tests ğŸ§ª
        working-directory: services/nexus-gateway
        env:
          DATABASE_URL: postgresql://nexus:nexus_test_password@localhost:5432/nexus_test
          JWT_SECRET: test-secret-not-for-production
          QUOTE_VALIDITY_SECONDS: 600
          PAYMENT_TIMEOUT_SECONDS: 60
        run: |
          pytest tests/ -v --tb=short --cov=src --cov-report=xml

      - name: Upload Coverage ğŸ“Š
        uses: codecov/codecov-action@v3
        with:
          files: services/nexus-gateway/coverage.xml
          fail_ci_if_error: false

  frontend-build:
    name: Frontend Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Set up Node.js âš™ï¸
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: 'services/demo-dashboard/package-lock.json'

      - name: Install Dependencies ğŸ“¦
        working-directory: services/demo-dashboard
        run: npm ci

      - name: Type Check ğŸ“˜
        working-directory: services/demo-dashboard
        run: npx tsc --noEmit

      - name: Lint ğŸ§¹
        working-directory: services/demo-dashboard
        run: npm run lint || true

      - name: Build ğŸ—ï¸
        working-directory: services/demo-dashboard
        run: npm run build

  docker-compose-validation:
    name: Docker Compose Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Validate docker-compose.yml ğŸ³
        run: |
          docker compose -f docker-compose.yml config > /dev/null
          echo "âœ… Full compose file is valid"

      - name: Validate docker-compose.lite.yml ğŸ³
        run: |
          docker compose -f docker-compose.lite.yml config > /dev/null
          echo "âœ… Lite compose file is valid"

  migration-validation:
    name: Database Migration Validation
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: nexus_migration_test
          POSTGRES_USER: nexus
          POSTGRES_PASSWORD: nexus_test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Wait for PostgreSQL â³
        run: |
          until pg_isready -h localhost -p 5432 -U nexus; do
            echo "Waiting for PostgreSQL..."
            sleep 1
          done

      - name: Run Migrations ğŸ—„ï¸
        env:
          PGPASSWORD: nexus_test_password
        run: |
          # Get list of migration files in order
          for f in $(ls migrations/*.sql | sort); do
            echo "Running migration: $f"
            psql -h localhost -p 5432 -U nexus -d nexus_migration_test -f "$f"
          done
          echo "âœ… All migrations completed successfully"

      - name: Verify Schema ğŸ§©
        env:
          PGPASSWORD: nexus_test_password
        run: |
          # Check that key tables exist
          psql -h localhost -p 5432 -U nexus -d nexus_migration_test -c "
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public' 
            ORDER BY table_name;
          "

  code-quality-checks:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Check for Debug Statements ğŸ›
        run: |
          # Check for leftover debug statements
          if grep -r "console.log\|print(\|debugger" --include="*.py" --include="*.ts" --include="*.tsx" services/ | grep -v "node_modules"; then
            echo "âš ï¸ Found potential debug statements"
          fi

      - name: Check File Naming Convention ğŸ“
        run: |
          # Check for consistent naming
          find services -name "*.py" -o -name "*.ts" -o -name "*.tsx" | while read f; do
            if [[ "$f" == *" "* ]]; then
              echo "âŒ File with spaces: $f"
              exit 1
            fi
          done
          echo "âœ… File naming looks good"

      - name: Validate Markdown Links ğŸ”—
        uses: lycheeverse/lychee-action@v1
        with:
          args: --timeout 30 --max-concurrency 1 docs/*.md *.md
          fail: false
